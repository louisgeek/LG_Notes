## TCP 传输控制协议

- Transmission Control Protocol 
- 面向连接
- 双向通讯协议
- 可靠的传输，可靠连接是靠 seq（ sequence numbers 序列号）来达成的

 





## 三次握手

- Three-way handshake 准确的说是三步握手，三次通信完成握手
- 指的是需要三个步骤才能够建立连接的机制

由于 HTTP 无状态的特点，每次 HTTP 请求都需要通过 TCP 进行三次握手保证双方具有接收和发送的能力，即在信道不可靠情况下, 要保证可靠的数据传输，就需要至少三次通信，即双方确认自己与对方的发送与接收是否正常

### TCP 连接

用于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括**Socket、序列号和窗口大小**称为连接





## 四步握手

- 序列号初始化是随机的

客户端-> SYN =1 同步 seq = <Client Init Seq Num>    ->服务端【客户端进入 SYN-SENT 同步已发送状态】

客户端<- ACK =1 确认 ack =  <Client Init Seq Num> +1 <-服务端【服务端进入SYN-RCVD同步已收到状态】

客户端<- SYN =1 同步 seq =  <Server Init Seq Num>   <- 服务端 （可以和上一步合并）

客户端-> ACK =1 确认 ack =  <Server Init Seq Num> +1  -> 服务端【客户端进入ESTABLISHED连接已确认状态】

第二步、第三步可以合并，变成三步握手



## 为什么需要三次握手？

如果只做两次握手，客户端发送了第一个连接的请求报文，但是由于网络不好，这个请求没有立即到达服务端，而是在某个网络节点中滞留了，直到某个时间才到达server，本来这已经是一个失效的报文，但是server端接收到这个请求报文后，还是会想client发出确认的报文，表示同意连接。

假如不采用三次握手，那么只要server发出确认，新的建立就连接了，但其实这个请求是失效的请求，client是不会理睬server的确认信息，也不会向服务端发送确认的请求，但是server认为新的连接已经建立起来了，并一直等待client发来数据，这样，server的很多资源就没白白浪费掉了，采用三次握手就是为了防止这种情况的发生，server会因为收不到确认的报文，就知道client并没有建立连接。这就是三次握手的作用。



### 防止旧的重复连接初始化

客户端发现是旧的连接，会向服务端发送 RST 重置报文以终止这个连接



### 同步双方的初始序列号

通过一来一回，双方都知晓对方的初始序列号，被可靠的同步



### 避免资源浪费

如果只做两次握手，在消息滞留的情况下，服务器会重复接受无用的连接请求 SYN 报文，而造成重复分配资源







通过TCP 连接发送的每一个 Segment 包，都有一个 sequence number，而因为每个包都是有序列号的，所以都能被确认收到这些包。



## ISN 初始化序列号

- Init Sequense Number

为了建立可靠连接，需要对客户端和服务器的起始序列号达成共识



## SYN 同步标志

- Synchronize Sequence Numbers 同步序列编号

TCP 规定 SYN =1 报文段不能携带数据，但需要消耗掉一个序号，表示三次握手中的开始，即表示客户端想要和服务端建立连接





## ACK 确认标志

- Acknowledge Number

TCP 规定 ACK =1 报文端不能携带数据，但需要消耗掉一个序号，表示服务端同意客户端的连接





## 四次挥手

- <U> 的值等于前面已经传送过来的数据的最后一个字节的序号加 1

客户端-> FIN =1 结束 seq = <U> ->服务端【客户端进入 FIN-WAIT-1 中止等待 1 状态】

客户端<- ACK =1 确认 ack =  <U> +1 <-服务端【服务端进入 CLOSE-WAIT 关闭等待状态】

客户端<- ？seq =  V   <- 服务端 （可以和上一步合并）

客户端<-  FIN =1 结束 seq = <W>  <-  服务端【客户端就进入 FIN-WAIT-2 终止等待 2 状态】

客户端<-  ACK =1 确认 ack = <U> +1   <-  服务端

客户端-> ACK =1 确认 ack =  <U> +1  -> 服务端

客户端-> ACK =1 确认 ack =  <W> +1  -> 服务端



FIN

- FINISH

结束

TCP 规定 FIN 报文段即使不携带数据，也要消耗一个序号



PSH

传送



 



 RST

重置



URG

紧急