MQTT 消息队列遥测传输

- Message Queuing Telemetry Transport



## 物联网消息传递标准

IoT 物联网 的 OASIS 标准消息传递协议

IoT 物联网

- Internet of Things





QoS



OASIS 

是一个非营利性组织，旨在合作开发和批准开放的国际标准，主要是基于 XML 的标准

OASIS Open 是世界上最受尊敬的非营利性标准机构之一，它为包括开源项目在内的项目提供了一条标准化和法律批准的道路，供国际政策和采购参考。

人们加入 OASIS，推进网络安全、区块链、物联网、应急管理、云计算、法律数据交换等项目。技术各不相同，但我们的使命保持不变：通过全球协作和社区的力量，推动开放源软件和标准的公平、透明开发。







它被设计为一个非常轻量级的发布/订阅消息传输，非常适合连接具有小代码占用和最小网络带宽的远程设备。MQTT目前应用于汽车、制造、电信、石油和天然气等多个行业



EMQ





## 优点

### 轻量级且高效的

客户端非常小巧，尽可能依赖最少的资源，所以可以被用在小型微控制器上

消息头小，充分利用网络带宽



### 双向通信

允许消息从客户端到服务端、服务端到客户端双向传递，所以很容易实现消息广播到物联网设备群



### 连接百万设备

可以扩展规模，可扩展百万物联网设备



### 可靠的消息传递

消息的可靠传递是必要的

#### 消息发布三个服务质量

- 最多一次

<=1 消息可能丢失

- 至少一次

\>=1 消息可能重复

- 正好一次

=1

### 支持运行在不可靠的网络

大量设备运行在蜂窝网络下，意味着网络不是那么可靠

支持持续会话减少设备重连服务器的时间



### 安全保证

很容易通过 TLS 加密传输，以及利用现代认证协议（如 OAuth）去认证设备方式，实现客户端的认证





![MQTT： 发布/ 订阅架构](C:\Users\zhufangquan\Desktop\mqtt-publish-subscribe.png)



MQTT协议是一种基于客户端、服务器架构的、以发布和订阅方式传递消息的一种消息传输协议。MQTT是一种轻量的、开放的、易用的和易实现的协议，这些特性使MQTT能够适应不同的使用环境，包括资源受限的场景，比如M2M通讯和各种物联网应用场景。此次通过的MQTT 5.0是自2014年的3.1.1版本以来的一次重要的协议升级，新协议能适应近年来行业发展的新需求，同时也为未来物联网行业发展的做了协议上的准备。

 

一种基于发布/订阅（publish/subscribe）模式的"轻量级"通讯协议，该协议构建于TCP/IP协议上

优点在于，可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。作为一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用。

MQTT是一个基于客户端-服务器的消息发布/订阅传输协议

MQTT协议是轻量、简单、开放和易于实现的，这些特点使它适用范围非常广泛。在很多情况下，包括受限的环境中，如：机器与机器（M2M）通信和物联网（IoT）。



医疗设备、智能家居及一些小型设备中已广泛使用。





- （1）精简，不添加可有可无的功能；
- （2）发布/订阅（Pub/Sub）模式，方便消息在传感器之间传递；
- （3）允许用户动态创建主题，零运维成本；
- （4）把传输量降到最低以提高传输效率；
- （5）把低带宽、高延迟、不稳定的网络等因素考虑在内；
- （6）支持连续的会话控制；
- （7）理解客户端计算能力可能很低；
- （8）提供服务质量管理；
- （9）假设数据不可知，不强求传输数据的类型与格式，保持灵活性。







Publish 发布者（客户端）

Broker 消息代理（服务器）

Subscribe 订阅者（客户端）

消息的发布者也可以同时是订阅者



Topic 主题（消息的类型）

Payload 消息的内容








99 年：IBM 推出 MQTT 协议，最开始是用于通过卫星连接石油管道遥测系统，MQTT 中的 TT (Telemetry Transport) 就是源于这样一个遥测系统，10 年：MQTT 协议免费发布，14 年：MQTT 协议正式成为 OASIS 标准



MQTT 是基于 TCP 的应用层协议





针对两个痛点设计：

硬件性能低下 

网络状况不稳定的场景



在低带宽高延迟不可靠的网络下进行数据相对可靠传输的应用层协议，用于物联网数据传输、IM聊天软件等



消息上限

MQTT 的传输单位是消息，每条消息字节上限在 MQTT Broker 代理服务器上进行设置





QoS

- “正好一次” 用于计费系统和 IM App 推送中，能确保用户收到且只收到一次；





 提供了遗嘱消息和保留消息的特性





发布者和订阅者通过 broker 进行消息传递，相互之间感知不到对方的存在。当一个客户端断线时，整个系统可以继续工作





publisher 和 subscriber 不一定需要同时运行





MQTT 是一种基于二进制的协议，所谓基于二进制，**是指 MQTT 协议操作的元素是二进制数据而不是文本数据**

MQTT是不支持分包等机制，并不适宜一些数据包特别大的应用场景。





采用命令 & 命令确认的格式，每个命令消息都有一个关联的命令确认消息；



| **MQTT 消息结构**           | **描述**               | **长度**    |
| --------------------------- | ---------------------- | ----------- |
| 固定报头（Fixed header）    | 存在于所有 MQTT 消息中 | 2 到 5 字节 |
| 可变报头（Variable header） | 存在于部分 MQTT 消息中 | 0 或 N 字节 |
| 载荷（Payloads）            | 存在于部分 MQTT 消息中 | 0 或 N 字节 |

## 主题

$SYS

$SYS/brokers/+/clients/+/connected

$SYS/brokers/+/clients/+/disconnected



### 主题通配符

+

| **主题**    | 例子           |      |
| ----------- | -------------- | ---- |
| group/+/123 | group/temp/123 |      |
|             | group/qq/123   |      |
|             | group/wx/123   |      |







\#

| **主题** | 例子          |      |
| -------- | ------------- | ---- |
| group/#  | group         |      |
|          | group/123     |      |
|          | group/vip/123 |      |





## QoS 发布服务质量等级



### QoS 0 最多发一次

- At most once

### OoS 1   最少发一次

- At least once

  

### QoS2  正好发一次

- Exactly once

QoS是Sender和Receiver之间的协议，而不是Publisher和Subscriber之间的协议。换句话说，Publisher发布了一条QoS1的消息，只能保证Broker能至少收到一次这个消息；而对于Subscriber能否至少收到一次这个消息，还要取决于Subscriber在Subscibe的时候和Broker协商的QoS等级

 



- EMQ X ([www.emqx.com/zh/download…](https://link.juejin.cn/?target=https%3A%2F%2Fwww.emqx.com%2Fzh%2Fdownloads%3Fproduct%3Dbroker))
- ActiveMQ/Artemis([activemq.apache.org/](https://link.juejin.cn/?target=https%3A%2F%2Factivemq.apache.org%2F))



